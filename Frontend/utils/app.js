import { ethers } from "ethers";
import { Database, helpers } from "@tableland/sdk";
import { routerABI } from "./RouterABI";
import { formABI } from "./formABI";
import { controllerABI } from "./controllerABI";
import axios from 'axios';
import { Web3Storage } from "web3.storage";

require("dotenv").config();

const bytecode = "60806040523480156200001157600080fd5b5060405162005013380380620050138339818101604052810190620000379190620001c9565b6040518060400160405280600481526020017f68617368000000000000000000000000000000000000000000000000000000008152506200007e816200014a60201b60201c565b5033600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505062000571565b80600290816200015b91906200048a565b5050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620001918262000164565b9050919050565b620001a38162000184565b8114620001af57600080fd5b50565b600081519050620001c38162000198565b92915050565b60008060408385031215620001e357620001e26200015f565b5b6000620001f385828601620001b2565b92505060206200020685828601620001b2565b9150509250929050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200029257607f821691505b602082108103620002a857620002a76200024a565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620003127fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620002d3565b6200031e8683620002d3565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006200036b620003656200035f8462000336565b62000340565b62000336565b9050919050565b6000819050919050565b62000387836200034a565b6200039f620003968262000372565b848454620002e0565b825550505050565b600090565b620003b6620003a7565b620003c38184846200037c565b505050565b5b81811015620003eb57620003df600082620003ac565b600181019050620003c9565b5050565b601f8211156200043a576200040481620002ae565b6200040f84620002c3565b810160208510156200041f578190505b620004376200042e85620002c3565b830182620003c8565b50505b505050565b600082821c905092915050565b60006200045f600019846008026200043f565b1980831691505092915050565b60006200047a83836200044c565b9150826002028217905092915050565b620004958262000210565b67ffffffffffffffff811115620004b157620004b06200021b565b5b620004bd825462000279565b620004ca828285620003ef565b600060209050601f831160018114620005025760008415620004ed578287015190505b620004f985826200046c565b86555062000569565b601f1984166200051286620002ae565b60005b828110156200053c5784890151825560018201915060208501945060208101905062000515565b868310156200055c578489015162000558601f8916826200044c565b8355505b6001600288020188555050505b505050505050565b614a9280620005816000396000f3fe6080604052600436106101125760003560e01c80634e1273f4116100a0578063a87d942c11610064578063a87d942c146103cd578063b504b0b1146103f8578063b5a01c4e14610435578063e985e9c514610460578063f242432a1461049d57610112565b80634e1273f4146102f757806381909ebb146103345780638da5cb5b146103505780639fe1c16e1461037b578063a22cb465146103a457610112565b80630e89341c116100e75780630e89341c146101f7578063150b7a0214610234578063195e251f146102715780632eb2c2d6146102b257806339987448146102db57610112565b806263bdac14610117578062fdd58e1461015457806301ffc9a7146101915780630a531dfd146101ce575b600080fd5b34801561012357600080fd5b5061013e60048036038101906101399190612a87565b6104c6565b60405161014b9190612b44565b60405180910390f35b34801561016057600080fd5b5061017b60048036038101906101769190612bc4565b61056e565b6040516101889190612c13565b60405180910390f35b34801561019d57600080fd5b506101b860048036038101906101b39190612c86565b610636565b6040516101c59190612cce565b60405180910390f35b3480156101da57600080fd5b506101f560048036038101906101f09190612e1e565b610718565b005b34801561020357600080fd5b5061021e60048036038101906102199190612a87565b610aa3565b60405161022b9190612b44565b60405180910390f35b34801561024057600080fd5b5061025b60048036038101906102569190612f96565b610b37565b6040516102689190613028565b60405180910390f35b34801561027d57600080fd5b5061029860048036038101906102939190612a87565b610b4b565b6040516102a9959493929190613043565b60405180910390f35b3480156102be57600080fd5b506102d960048036038101906102d49190613173565b610d78565b005b6102f560048036038101906102f09190613323565b610e19565b005b34801561030357600080fd5b5061031e60048036038101906103199190613442565b611372565b60405161032b9190613578565b60405180910390f35b61034e6004803603810190610349919061359a565b61148b565b005b34801561035c57600080fd5b5061036561151f565b60405161037291906135e9565b60405180910390f35b34801561038757600080fd5b506103a2600480360381019061039d9190613604565b611545565b005b3480156103b057600080fd5b506103cb60048036038101906103c69190613670565b61162f565b005b3480156103d957600080fd5b506103e2611645565b6040516103ef9190612c13565b60405180910390f35b34801561040457600080fd5b5061041f600480360381019061041a9190612a87565b611656565b60405161042c9190612b44565b60405180910390f35b34801561044157600080fd5b5061044a6116fb565b60405161045791906135e9565b60405180910390f35b34801561046c57600080fd5b50610487600480360381019061048291906136b0565b611721565b6040516104949190612cce565b60405180910390f35b3480156104a957600080fd5b506104c460048036038101906104bf91906136f0565b6117b5565b005b60606007600083815260200190815260200160002060030180546104e9906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610515906137b6565b80156105625780601f1061053757610100808354040283529160200191610562565b820191906000526020600020905b81548152906001019060200180831161054557829003601f168201915b50505050509050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036105de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105d590613859565b60405180910390fd5b60008083815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60007fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061070157507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b80610711575061071082611856565b5b9050919050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461077257600080fd5b600061077c6118c0565b73ffffffffffffffffffffffffffffffffffffffff1663a15ab08d306107c1876040516020016107ac91906138db565b60405160208183030381529060405289611abf565b6040518363ffffffff1660e01b81526004016107de929190613901565b6020604051808303816000875af11580156107fd573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108219190613946565b905060008561082f46611af5565b61083884611af5565b60405160200161084a93929190613999565b6040516020818303038152906040529050836007600061086a6003611bc3565b815260200190815260200160002060040190816108879190613b94565b5085600760006108976003611bc3565b815260200190815260200160002060020190816108b49190613b94565b506108bf6003611bc3565b600760006108cd6003611bc3565b81526020019081526020016000206000018190555081600760006108f16003611bc3565b81526020019081526020016000206001018190555080600760006109156003611bc3565b815260200190815260200160002060030190816109329190613b94565b5061093b6118c0565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab973084600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161099993929190613c66565b600060405180830381600087803b1580156109b357600080fd5b505af11580156109c7573d6000803e3d6000fd5b5050505082600960006109da6003611bc3565b815260200190815260200160002090816109f49190613b94565b50600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16633db88432338830610a406003611bc3565b6040518563ffffffff1660e01b8152600401610a5f9493929190613c9d565b600060405180830381600087803b158015610a7957600080fd5b505af1158015610a8d573d6000803e3d6000fd5b50505050610a9b6003611bd1565b505050505050565b606060028054610ab2906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610ade906137b6565b8015610b2b5780601f10610b0057610100808354040283529160200191610b2b565b820191906000526020600020905b815481529060010190602001808311610b0e57829003601f168201915b50505050509050919050565b600063150b7a0260e01b9050949350505050565b60006060806060600060076000878152602001908152602001600020600001546007600088815260200190815260200160002060020160076000898152602001908152602001600020600401600960008a8152602001908152602001600020600760008b815260200190815260200160002060050154838054610bcd906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610bf9906137b6565b8015610c465780601f10610c1b57610100808354040283529160200191610c46565b820191906000526020600020905b815481529060010190602001808311610c2957829003601f168201915b50505050509350828054610c59906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610c85906137b6565b8015610cd25780601f10610ca757610100808354040283529160200191610cd2565b820191906000526020600020905b815481529060010190602001808311610cb557829003601f168201915b50505050509250818054610ce5906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610d11906137b6565b8015610d5e5780601f10610d3357610100808354040283529160200191610d5e565b820191906000526020600020905b815481529060010190602001808311610d4157829003601f168201915b505050505091509450945094509450945091939590929450565b610d80611be7565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480610dc65750610dc585610dc0611be7565b611721565b5b610e05576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dfc90613d5b565b60405180910390fd5b610e128585858585611bef565b5050505050565b6000610e2482611f10565b90506000600960008581526020019081526020016000208054610e46906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610e72906137b6565b8015610ebf5780601f10610e9457610100808354040283529160200191610ebf565b820191906000526020600020905b815481529060010190602001808311610ea257829003601f168201915b50505050509050600860008581526020019081526020016000206001015447118015610f01575060006008600086815260200190815260200160002060000154115b1561119357610f0e6118c0565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da34306007600089815260200190815260200160002060010154611060600760008b81526020019081526020016000206002018054610f66906137b6565b80601f0160208091040260200160405190810160405280929190818152602001828054610f92906137b6565b8015610fdf5780601f10610fb457610100808354040283529160200191610fdf565b820191906000526020600020905b815481529060010190602001808311610fc257829003601f168201915b5050505050600760008c8152602001908152602001600020600101548860405160200161100c9190613da1565b60405160208183030381529060405261103a600760008f815260200190815260200160002060050154611af5565b8b60405160200161104c929190613ded565b604051602081830303815290604052611fe2565b6040518563ffffffff1660e01b815260040161107e93929190613e20565b6000604051808303818588803b15801561109757600080fd5b505af11580156110ab573d6000803e3d6000fd5b50505050506000803373ffffffffffffffffffffffffffffffffffffffff16346040516110d790613e8f565b60006040518083038185875af1925050503d8060008114611114576040519150601f19603f3d011682016040523d82523d6000602084013e611119565b606091505b50915091508161115e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161115590613ef0565b60405180910390fd5b60016007600088815260200190815260200160002060050160008282546111859190613f3f565b92505081905550505061136c565b61119b6118c0565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da343060076000898152602001908152602001600020600101546112ed600760008b815260200190815260200160002060020180546111f3906137b6565b80601f016020809104026020016040519081016040528092919081815260200182805461121f906137b6565b801561126c5780601f106112415761010080835404028352916020019161126c565b820191906000526020600020905b81548152906001019060200180831161124f57829003601f168201915b5050505050600760008c815260200190815260200160002060010154886040516020016112999190613da1565b6040516020818303038152906040526112c7600760008f815260200190815260200160002060050154611af5565b8b6040516020016112d9929190613ded565b604051602081830303815290604052611fe2565b6040518563ffffffff1660e01b815260040161130b93929190613e20565b6000604051808303818588803b15801561132457600080fd5b505af1158015611338573d6000803e3d6000fd5b505050505060016007600086815260200190815260200160002060050160008282546113649190613f3f565b925050819055505b50505050565b606081518351146113b8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113af90613fe5565b60405180910390fd5b6000835167ffffffffffffffff8111156113d5576113d4612cf3565b5b6040519080825280602002602001820160405280156114035781602001602082028036833780820191505090505b50905060005b84518110156114805761145085828151811061142857611427614005565b5b602002602001015185838151811061144357611442614005565b5b602002602001015161056e565b82828151811061146357611462614005565b5b6020026020010181815250508061147990614034565b9050611409565b508091505092915050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146114e557600080fd5b3460086000848152602001908152602001600020600001819055508060086000848152602001908152602001600020600101819055505050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461159f57600080fd5b6115a76118c0565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab97306007600086815260200190815260200160002060010154846040518463ffffffff1660e01b81526004016115f993929190613c66565b600060405180830381600087803b15801561161357600080fd5b505af1158015611627573d6000803e3d6000fd5b505050505050565b61164161163a611be7565b8383612021565b5050565b60006116516003611bc3565b905090565b6060600960008381526020019081526020016000208054611676906137b6565b80601f01602080910402602001604051908101604052809291908181526020018280546116a2906137b6565b80156116ef5780601f106116c4576101008083540402835291602001916116ef565b820191906000526020600020905b8154815290600101906020018083116116d257829003601f168201915b50505050509050919050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b6117bd611be7565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614806118035750611802856117fd611be7565b611721565b5b611842576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161183990613d5b565b60405180910390fd5b61184f858585858561218d565b5050505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b6000600146036118e65773012969f7e3439a9b04025b5a049eb9bad82a8c129050611abc565b600a460361190a5773fad44bf5b843de943a09d4f3e84949a11d3aa3e69050611abc565b61a4b1460361192f57739abd75e8640871a5a20d3b4ee6330a04c962affd9050611abc565b61a4ba460361195457731a22854c5b1642760a827f20137a67930ae108d29050611abc565b6089460361197857735c4e6a9e5c1e1bf445a062006faf19ea6c49afea9050611abc565b61013a460361199d577359ef8bf2d6c102b4c42aef9189e1a9f0abfd652d9050611abc565b62aa36a746036119c35773c50c62498448acc8dbde43da77f8d5d2e2c7597d9050611abc565b6101a446036119e85773c72e8a7be04f2469f8c2db3f1bdf69a7d516abba9050611abc565b62066eed4603611a0e5773033f69e8d119205089ab15d340f5b797732f646b9050611abc565b620138814603611a3457734b48841d4b32c4650e4abc117a03fe8b51f38f689050611abc565b6204cb2f4603611a5a5773030bcf3d50cad04c2e57391b12740982a93086219050611abc565b617a694603611a7f5773e7f1725e7734ce288f8367e1bb143e90bb3f05129050611abc565b466040517f264e42cf000000000000000000000000000000000000000000000000000000008152600401611ab39190612c13565b60405180910390fd5b90565b606081611acb46611af5565b84604051602001611ade939291906141ac565b604051602081830303815290604052905092915050565b606060006001611b0484612428565b01905060008167ffffffffffffffff811115611b2357611b22612cf3565b5b6040519080825280601f01601f191660200182016040528015611b555781602001600182028036833780820191505090505b509050600082602001820190505b600115611bb8578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a8581611bac57611bab614209565b5b04945060008503611b63575b819350505050919050565b600081600001549050919050565b6001816000016000828254019250508190555050565b600033905090565b8151835114611c33576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c2a906142aa565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603611ca2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c999061433c565b60405180910390fd5b6000611cac611be7565b9050611cbc81878787878761257b565b60005b8451811015611e6d576000858281518110611cdd57611cdc614005565b5b602002602001015190506000858381518110611cfc57611cfb614005565b5b60200260200101519050600080600084815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015611d9d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611d94906143ce565b60405180910390fd5b81810360008085815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160008085815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611e529190613f3f565b9250508190555050505080611e6690614034565b9050611cbf565b508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611ee49291906143ee565b60405180910390a4611efa818787878787612583565b611f0881878787878761258b565b505050505050565b60608060005b8351811015611fd85760018451611f2d9190614425565b8103611f7e5781611f57858381518110611f4a57611f49614005565b5b6020026020010151612762565b604051602001611f68929190614459565b6040516020818303038152906040529150611fc5565b81611fa2858381518110611f9557611f94614005565b5b6020026020010151612762565b604051602001611fb392919061447d565b60405160208183030381529060405291505b8080611fd090614034565b915050611f16565b5080915050919050565b60606000611ff0868661278b565b905080848460405160200161200793929190614548565b604051602081830303815290604052915050949350505050565b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361208f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161208690614617565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31836040516121809190612cce565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff16036121fc576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016121f39061433c565b60405180910390fd5b6000612206611be7565b90506000612213856127c9565b90506000612220856127c9565b905061223083898985858961257b565b600080600088815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050858110156122c7576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016122be906143ce565b60405180910390fd5b85810360008089815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508560008089815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461237c9190613f3f565b925050819055508773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628a8a6040516123f9929190614637565b60405180910390a461240f848a8a86868a612583565b61241d848a8a8a8a8a612843565b505050505050505050565b600080600090507a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310612486577a184f03e93ff9f4daa797ed6e38ed64bf6a1f010000000000000000838161247c5761247b614209565b5b0492506040810190505b6d04ee2d6d415b85acef810000000083106124c3576d04ee2d6d415b85acef810000000083816124b9576124b8614209565b5b0492506020810190505b662386f26fc1000083106124f257662386f26fc1000083816124e8576124e7614209565b5b0492506010810190505b6305f5e100831061251b576305f5e100838161251157612510614209565b5b0492506008810190505b612710831061254057612710838161253657612535614209565b5b0492506004810190505b60648310612563576064838161255957612558614209565b5b0492506002810190505b600a8310612572576001810190505b80915050919050565b505050505050565b505050505050565b6125aa8473ffffffffffffffffffffffffffffffffffffffff16612a1a565b1561275a578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b81526004016125f09594939291906146b5565b6020604051808303816000875af192505050801561262c57506040513d601f19601f820116820180604052508101906126299190614732565b60015b6126d15761263861476c565b806308c379a003612694575061264c61478e565b806126575750612696565b806040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161268b9190612b44565b60405180910390fd5b505b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016126c890614890565b60405180910390fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614612758576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161274f90614922565b60405180910390fd5b505b505050505050565b606081604051602001612775919061498e565b6040516020818303038152906040529050919050565b60608261279746611af5565b6127a084611af5565b6040516020016127b2939291906149bb565b604051602081830303815290604052905092915050565b60606000600167ffffffffffffffff8111156127e8576127e7612cf3565b5b6040519080825280602002602001820160405280156128165781602001602082028036833780820191505090505b509050828160008151811061282e5761282d614005565b5b60200260200101818152505080915050919050565b6128628473ffffffffffffffffffffffffffffffffffffffff16612a1a565b15612a12578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b81526004016128a8959493929190614a02565b6020604051808303816000875af19250505080156128e457506040513d601f19601f820116820180604052508101906128e19190614732565b60015b612989576128f061476c565b806308c379a00361294c575061290461478e565b8061290f575061294e565b806040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016129439190612b44565b60405180910390fd5b505b6040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161298090614890565b60405180910390fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614612a10576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612a0790614922565b60405180910390fd5b505b505050505050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b612a6481612a51565b8114612a6f57600080fd5b50565b600081359050612a8181612a5b565b92915050565b600060208284031215612a9d57612a9c612a47565b5b6000612aab84828501612a72565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015612aee578082015181840152602081019050612ad3565b60008484015250505050565b6000601f19601f8301169050919050565b6000612b1682612ab4565b612b208185612abf565b9350612b30818560208601612ad0565b612b3981612afa565b840191505092915050565b60006020820190508181036000830152612b5e8184612b0b565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000612b9182612b66565b9050919050565b612ba181612b86565b8114612bac57600080fd5b50565b600081359050612bbe81612b98565b92915050565b60008060408385031215612bdb57612bda612a47565b5b6000612be985828601612baf565b9250506020612bfa85828601612a72565b9150509250929050565b612c0d81612a51565b82525050565b6000602082019050612c286000830184612c04565b92915050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b612c6381612c2e565b8114612c6e57600080fd5b50565b600081359050612c8081612c5a565b92915050565b600060208284031215612c9c57612c9b612a47565b5b6000612caa84828501612c71565b91505092915050565b60008115159050919050565b612cc881612cb3565b82525050565b6000602082019050612ce36000830184612cbf565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b612d2b82612afa565b810181811067ffffffffffffffff82111715612d4a57612d49612cf3565b5b80604052505050565b6000612d5d612a3d565b9050612d698282612d22565b919050565b600067ffffffffffffffff821115612d8957612d88612cf3565b5b612d9282612afa565b9050602081019050919050565b82818337600083830152505050565b6000612dc1612dbc84612d6e565b612d53565b905082815260208101848484011115612ddd57612ddc612cee565b5b612de8848285612d9f565b509392505050565b600082601f830112612e0557612e04612ce9565b5b8135612e15848260208601612dae565b91505092915050565b60008060008060808587031215612e3857612e37612a47565b5b600085013567ffffffffffffffff811115612e5657612e55612a4c565b5b612e6287828801612df0565b945050602085013567ffffffffffffffff811115612e8357612e82612a4c565b5b612e8f87828801612df0565b935050604085013567ffffffffffffffff811115612eb057612eaf612a4c565b5b612ebc87828801612df0565b925050606085013567ffffffffffffffff811115612edd57612edc612a4c565b5b612ee987828801612df0565b91505092959194509250565b600067ffffffffffffffff821115612f1057612f0f612cf3565b5b612f1982612afa565b9050602081019050919050565b6000612f39612f3484612ef5565b612d53565b905082815260208101848484011115612f5557612f54612cee565b5b612f60848285612d9f565b509392505050565b600082601f830112612f7d57612f7c612ce9565b5b8135612f8d848260208601612f26565b91505092915050565b60008060008060808587031215612fb057612faf612a47565b5b6000612fbe87828801612baf565b9450506020612fcf87828801612baf565b9350506040612fe087828801612a72565b925050606085013567ffffffffffffffff81111561300157613000612a4c565b5b61300d87828801612f68565b91505092959194509250565b61302281612c2e565b82525050565b600060208201905061303d6000830184613019565b92915050565b600060a0820190506130586000830188612c04565b818103602083015261306a8187612b0b565b9050818103604083015261307e8186612b0b565b905081810360608301526130928185612b0b565b90506130a16080830184612c04565b9695505050505050565b600067ffffffffffffffff8211156130c6576130c5612cf3565b5b602082029050602081019050919050565b600080fd5b60006130ef6130ea846130ab565b612d53565b90508083825260208201905060208402830185811115613112576131116130d7565b5b835b8181101561313b57806131278882612a72565b845260208401935050602081019050613114565b5050509392505050565b600082601f83011261315a57613159612ce9565b5b813561316a8482602086016130dc565b91505092915050565b600080600080600060a0868803121561318f5761318e612a47565b5b600061319d88828901612baf565b95505060206131ae88828901612baf565b945050604086013567ffffffffffffffff8111156131cf576131ce612a4c565b5b6131db88828901613145565b935050606086013567ffffffffffffffff8111156131fc576131fb612a4c565b5b61320888828901613145565b925050608086013567ffffffffffffffff81111561322957613228612a4c565b5b61323588828901612f68565b9150509295509295909350565b600067ffffffffffffffff82111561325d5761325c612cf3565b5b602082029050602081019050919050565b600061328161327c84613242565b612d53565b905080838252602082019050602084028301858111156132a4576132a36130d7565b5b835b818110156132eb57803567ffffffffffffffff8111156132c9576132c8612ce9565b5b8086016132d68982612df0565b855260208501945050506020810190506132a6565b5050509392505050565b600082601f83011261330a57613309612ce9565b5b813561331a84826020860161326e565b91505092915050565b6000806040838503121561333a57613339612a47565b5b600061334885828601612a72565b925050602083013567ffffffffffffffff81111561336957613368612a4c565b5b613375858286016132f5565b9150509250929050565b600067ffffffffffffffff82111561339a57613399612cf3565b5b602082029050602081019050919050565b60006133be6133b98461337f565b612d53565b905080838252602082019050602084028301858111156133e1576133e06130d7565b5b835b8181101561340a57806133f68882612baf565b8452602084019350506020810190506133e3565b5050509392505050565b600082601f83011261342957613428612ce9565b5b81356134398482602086016133ab565b91505092915050565b6000806040838503121561345957613458612a47565b5b600083013567ffffffffffffffff81111561347757613476612a4c565b5b61348385828601613414565b925050602083013567ffffffffffffffff8111156134a4576134a3612a4c565b5b6134b085828601613145565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6134ef81612a51565b82525050565b600061350183836134e6565b60208301905092915050565b6000602082019050919050565b6000613525826134ba565b61352f81856134c5565b935061353a836134d6565b8060005b8381101561356b57815161355288826134f5565b975061355d8361350d565b92505060018101905061353e565b5085935050505092915050565b60006020820190508181036000830152613592818461351a565b905092915050565b600080604083850312156135b1576135b0612a47565b5b60006135bf85828601612a72565b92505060206135d085828601612a72565b9150509250929050565b6135e381612b86565b82525050565b60006020820190506135fe60008301846135da565b92915050565b6000806040838503121561361b5761361a612a47565b5b600061362985828601612a72565b925050602061363a85828601612baf565b9150509250929050565b61364d81612cb3565b811461365857600080fd5b50565b60008135905061366a81613644565b92915050565b6000806040838503121561368757613686612a47565b5b600061369585828601612baf565b92505060206136a68582860161365b565b9150509250929050565b600080604083850312156136c7576136c6612a47565b5b60006136d585828601612baf565b92505060206136e685828601612baf565b9150509250929050565b600080600080600060a0868803121561370c5761370b612a47565b5b600061371a88828901612baf565b955050602061372b88828901612baf565b945050604061373c88828901612a72565b935050606061374d88828901612a72565b925050608086013567ffffffffffffffff81111561376e5761376d612a4c565b5b61377a88828901612f68565b9150509295509295909350565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806137ce57607f821691505b6020821081036137e1576137e0613787565b5b50919050565b7f455243313135353a2061646472657373207a65726f206973206e6f742061207660008201527f616c6964206f776e657200000000000000000000000000000000000000000000602082015250565b6000613843602a83612abf565b915061384e826137e7565b604082019050919050565b6000602082019050818103600083015261387281613836565b9050919050565b7f696420696e7465676572207072696d617279206b65792c000000000000000000815250565b600081905092915050565b60006138b582612ab4565b6138bf818561389f565b93506138cf818560208601612ad0565b80840191505092915050565b60006138e682613879565b6017820191506138f682846138aa565b915081905092915050565b600060408201905061391660008301856135da565b81810360208301526139288184612b0b565b90509392505050565b60008151905061394081612a5b565b92915050565b60006020828403121561395c5761395b612a47565b5b600061396a84828501613931565b91505092915050565b7f5f00000000000000000000000000000000000000000000000000000000000000815250565b60006139a582866138aa565b91506139b082613973565b6001820191506139c082856138aa565b91506139cb82613973565b6001820191506139db82846138aa565b9150819050949350505050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613a4a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613a0d565b613a548683613a0d565b95508019841693508086168417925050509392505050565b6000819050919050565b6000613a91613a8c613a8784612a51565b613a6c565b612a51565b9050919050565b6000819050919050565b613aab83613a76565b613abf613ab782613a98565b848454613a1a565b825550505050565b600090565b613ad4613ac7565b613adf818484613aa2565b505050565b5b81811015613b0357613af8600082613acc565b600181019050613ae5565b5050565b601f821115613b4857613b19816139e8565b613b22846139fd565b81016020851015613b31578190505b613b45613b3d856139fd565b830182613ae4565b50505b505050565b600082821c905092915050565b6000613b6b60001984600802613b4d565b1980831691505092915050565b6000613b848383613b5a565b9150826002028217905092915050565b613b9d82612ab4565b67ffffffffffffffff811115613bb657613bb5612cf3565b5b613bc082546137b6565b613bcb828285613b07565b600060209050601f831160018114613bfe5760008415613bec578287015190505b613bf68582613b78565b865550613c5e565b601f198416613c0c866139e8565b60005b82811015613c3457848901518255600182019150602085019450602081019050613c0f565b86831015613c515784890151613c4d601f891682613b5a565b8355505b6001600288020188555050505b505050505050565b6000606082019050613c7b60008301866135da565b613c886020830185612c04565b613c9560408301846135da565b949350505050565b6000608082019050613cb260008301876135da565b8181036020830152613cc48186612b0b565b9050613cd360408301856135da565b613ce06060830184612c04565b95945050505050565b7f455243313135353a2063616c6c6572206973206e6f7420746f6b656e206f776e60008201527f6572206f7220617070726f766564000000000000000000000000000000000000602082015250565b6000613d45602e83612abf565b9150613d5082613ce9565b604082019050919050565b60006020820190508181036000830152613d7481613d38565b9050919050565b7f69642c0000000000000000000000000000000000000000000000000000000000815250565b6000613dac82613d7b565b600382019150613dbc82846138aa565b915081905092915050565b7f2c00000000000000000000000000000000000000000000000000000000000000815250565b6000613df982856138aa565b9150613e0482613dc7565b600182019150613e1482846138aa565b91508190509392505050565b6000606082019050613e3560008301866135da565b613e426020830185612c04565b8181036040830152613e548184612b0b565b9050949350505050565b600081905092915050565b50565b6000613e79600083613e5e565b9150613e8482613e69565b600082019050919050565b6000613e9a82613e6c565b9150819050919050565b7f4661696c656420746f2073656e64204574686572000000000000000000000000600082015250565b6000613eda601483612abf565b9150613ee582613ea4565b602082019050919050565b60006020820190508181036000830152613f0981613ecd565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000613f4a82612a51565b9150613f5583612a51565b9250828201905080821115613f6d57613f6c613f10565b5b92915050565b7f455243313135353a206163636f756e747320616e6420696473206c656e67746860008201527f206d69736d617463680000000000000000000000000000000000000000000000602082015250565b6000613fcf602983612abf565b9150613fda82613f73565b604082019050919050565b60006020820190508181036000830152613ffe81613fc2565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061403f82612a51565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361407157614070613f10565b5b600182019050919050565b7f435245415445205441424c452000000000000000000000000000000000000000600082015250565b60006140b2600d8361389f565b91506140bd8261407c565b600d82019050919050565b7f5f00000000000000000000000000000000000000000000000000000000000000600082015250565b60006140fe60018361389f565b9150614109826140c8565b600182019050919050565b7f2800000000000000000000000000000000000000000000000000000000000000600082015250565b600061414a60018361389f565b915061415582614114565b600182019050919050565b7f2900000000000000000000000000000000000000000000000000000000000000600082015250565b600061419660018361389f565b91506141a182614160565b600182019050919050565b60006141b7826140a5565b91506141c382866138aa565b91506141ce826140f1565b91506141da82856138aa565b91506141e58261413d565b91506141f182846138aa565b91506141fc82614189565b9150819050949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060008201527f6d69736d61746368000000000000000000000000000000000000000000000000602082015250565b6000614294602883612abf565b915061429f82614238565b604082019050919050565b600060208201905081810360008301526142c381614287565b9050919050565b7f455243313135353a207472616e7366657220746f20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b6000614326602583612abf565b9150614331826142ca565b604082019050919050565b6000602082019050818103600083015261435581614319565b9050919050565b7f455243313135353a20696e73756666696369656e742062616c616e636520666f60008201527f72207472616e7366657200000000000000000000000000000000000000000000602082015250565b60006143b8602a83612abf565b91506143c38261435c565b604082019050919050565b600060208201905081810360008301526143e7816143ab565b9050919050565b60006040820190508181036000830152614408818561351a565b9050818103602083015261441c818461351a565b90509392505050565b600061443082612a51565b915061443b83612a51565b925082820390508181111561445357614452613f10565b5b92915050565b600061446582856138aa565b915061447182846138aa565b91508190509392505050565b600061448982856138aa565b915061449582846138aa565b91506144a082613dc7565b6001820191508190509392505050565b7f494e5345525420494e544f200000000000000000000000000000000000000000600082015250565b60006144e6600c8361389f565b91506144f1826144b0565b600c82019050919050565b7f2956414c55455328000000000000000000000000000000000000000000000000600082015250565b600061453260088361389f565b915061453d826144fc565b600882019050919050565b6000614553826144d9565b915061455f82866138aa565b915061456a8261413d565b915061457682856138aa565b915061458182614525565b915061458d82846138aa565b915061459882614189565b9150819050949350505050565b7f455243313135353a2073657474696e6720617070726f76616c2073746174757360008201527f20666f722073656c660000000000000000000000000000000000000000000000602082015250565b6000614601602983612abf565b915061460c826145a5565b604082019050919050565b60006020820190508181036000830152614630816145f4565b9050919050565b600060408201905061464c6000830185612c04565b6146596020830184612c04565b9392505050565b600081519050919050565b600082825260208201905092915050565b600061468782614660565b614691818561466b565b93506146a1818560208601612ad0565b6146aa81612afa565b840191505092915050565b600060a0820190506146ca60008301886135da565b6146d760208301876135da565b81810360408301526146e9818661351a565b905081810360608301526146fd818561351a565b90508181036080830152614711818461467c565b90509695505050505050565b60008151905061472c81612c5a565b92915050565b60006020828403121561474857614747612a47565b5b60006147568482850161471d565b91505092915050565b60008160e01c9050919050565b600060033d111561478b5760046000803e61478860005161475f565b90505b90565b600060443d1061481b576147a0612a3d565b60043d036004823e80513d602482011167ffffffffffffffff821117156147c857505061481b565b808201805167ffffffffffffffff8111156147e6575050505061481b565b80602083010160043d03850181111561480357505050505061481b565b61481282602001850186612d22565b82955050505050505b90565b7f455243313135353a207472616e7366657220746f206e6f6e2d4552433131353560008201527f526563656976657220696d706c656d656e746572000000000000000000000000602082015250565b600061487a603483612abf565b91506148858261481e565b604082019050919050565b600060208201905081810360008301526148a98161486d565b9050919050565b7f455243313135353a204552433131353552656365697665722072656a6563746560008201527f6420746f6b656e73000000000000000000000000000000000000000000000000602082015250565b600061490c602883612abf565b9150614917826148b0565b604082019050919050565b6000602082019050818103600083015261493b816148ff565b9050919050565b7f2700000000000000000000000000000000000000000000000000000000000000600082015250565b600061497860018361389f565b915061498382614942565b600182019050919050565b60006149998261496b565b91506149a582846138aa565b91506149b08261496b565b915081905092915050565b60006149c782866138aa565b91506149d2826140f1565b91506149de82856138aa565b91506149e9826140f1565b91506149f582846138aa565b9150819050949350505050565b600060a082019050614a1760008301886135da565b614a2460208301876135da565b614a316040830186612c04565b614a3e6060830185612c04565b8181036080830152614a50818461467c565b9050969550505050505056fea2646970667358221220467a22917639e51ef2d07b370043e78746dc61ebc3505699c0a1171d1d4caab164736f6c63430008120033"; // update bytecode

const controllerBytecode = "608060405234801561001057600080fd5b5033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610f7b806100616000396000f3fe6080604052600436106100555760003560e01c80633791dc6a1461005a57806366df322e1461008a57806369fe0e2d146100ba5780638da5cb5b146100e3578063d97cd55f1461010e578063ddca3f4314610137575b600080fd5b610074600480360381019061006f91906105e5565b610162565b6040516100819190610816565b60405180910390f35b6100a4600480360381019061009f919061086e565b61016f565b6040516100b19190610816565b60405180910390f35b3480156100c657600080fd5b506100e160048036038101906100dc91906108ae565b610364565b005b3480156100ef57600080fd5b506100f86103c8565b60405161010591906108ea565b60405180910390f35b34801561011a57600080fd5b5061013560048036038101906101309190610b64565b6103ee565b005b34801561014357600080fd5b5061014c610531565b6040516101599190610bcf565b60405180910390f35b61016a610537565b600080fd5b610177610537565b60005434146101bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101b290610c47565b60405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036102b9576040518060c00160405280600115158152602001600115158152602001600115158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff81111561027b5761027a61090a565b5b6040519080825280602002602001820160405280156102ae57816020015b60608152602001906001900390816102995790505b50815250905061035e565b6040518060c00160405280600115158152602001600115158152602001600115158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff8111156103245761032361090a565b5b60405190808252806020026020018201604052801561035757816020015b60608152602001906001900390816103425790505b5081525090505b92915050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146103be57600080fd5b8060008190555050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461044857600080fd5b80600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160000160016101000a81548160ff02191690831515021790555060408201518160000160026101000a81548160ff02191690831515021790555060608201518160010190816104fd9190610e73565b5060808201518160020190816105139190610e73565b5060a08201518160030190816105299190610e73565b509050505050565b60005481565b6040518060c001604052806000151581526020016000151581526020016000151581526020016060815260200160608152602001606081525090565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006105b282610587565b9050919050565b6105c2816105a7565b81146105cd57600080fd5b50565b6000813590506105df816105b9565b92915050565b6000602082840312156105fb576105fa61057d565b5b6000610609848285016105d0565b91505092915050565b60008115159050919050565b61062781610612565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561066757808201518184015260208101905061064c565b60008484015250505050565b6000601f19601f8301169050919050565b600061068f8261062d565b6106998185610638565b93506106a9818560208601610649565b6106b281610673565b840191505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b60006106f58383610684565b905092915050565b6000602082019050919050565b6000610715826106bd565b61071f81856106c8565b935083602082028501610731856106d9565b8060005b8581101561076d578484038952815161074e85826106e9565b9450610759836106fd565b925060208a01995050600181019050610735565b50829750879550505050505092915050565b600060c083016000830151610797600086018261061e565b5060208301516107aa602086018261061e565b5060408301516107bd604086018261061e565b50606083015184820360608601526107d58282610684565b915050608083015184820360808601526107ef8282610684565b91505060a083015184820360a0860152610809828261070a565b9150508091505092915050565b60006020820190508181036000830152610830818461077f565b905092915050565b6000819050919050565b61084b81610838565b811461085657600080fd5b50565b60008135905061086881610842565b92915050565b600080604083850312156108855761088461057d565b5b6000610893858286016105d0565b92505060206108a485828601610859565b9150509250929050565b6000602082840312156108c4576108c361057d565b5b60006108d284828501610859565b91505092915050565b6108e4816105a7565b82525050565b60006020820190506108ff60008301846108db565b92915050565b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61094282610673565b810181811067ffffffffffffffff821117156109615761096061090a565b5b80604052505050565b6000610974610573565b90506109808282610939565b919050565b600080fd5b61099381610612565b811461099e57600080fd5b50565b6000813590506109b08161098a565b92915050565b600080fd5b600080fd5b600067ffffffffffffffff8211156109db576109da61090a565b5b6109e482610673565b9050602081019050919050565b82818337600083830152505050565b6000610a13610a0e846109c0565b61096a565b905082815260208101848484011115610a2f57610a2e6109bb565b5b610a3a8482856109f1565b509392505050565b600082601f830112610a5757610a566109b6565b5b8135610a67848260208601610a00565b91505092915050565b600060c08284031215610a8657610a85610905565b5b610a9060c061096a565b90506000610aa0848285016109a1565b6000830152506020610ab4848285016109a1565b6020830152506040610ac8848285016109a1565b604083015250606082013567ffffffffffffffff811115610aec57610aeb610985565b5b610af884828501610a42565b606083015250608082013567ffffffffffffffff811115610b1c57610b1b610985565b5b610b2884828501610a42565b60808301525060a082013567ffffffffffffffff811115610b4c57610b4b610985565b5b610b5884828501610a42565b60a08301525092915050565b60008060408385031215610b7b57610b7a61057d565b5b6000610b89858286016105d0565b925050602083013567ffffffffffffffff811115610baa57610ba9610582565b5b610bb685828601610a70565b9150509250929050565b610bc981610838565b82525050565b6000602082019050610be46000830184610bc0565b92915050565b600082825260208201905092915050565b7f7061792066656520746f20696e73657274000000000000000000000000000000600082015250565b6000610c31601183610bea565b9150610c3c82610bfb565b602082019050919050565b60006020820190508181036000830152610c6081610c24565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610cae57607f821691505b602082108103610cc157610cc0610c67565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302610d297fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610cec565b610d338683610cec565b95508019841693508086168417925050509392505050565b6000819050919050565b6000610d70610d6b610d6684610838565b610d4b565b610838565b9050919050565b6000819050919050565b610d8a83610d55565b610d9e610d9682610d77565b848454610cf9565b825550505050565b600090565b610db3610da6565b610dbe818484610d81565b505050565b5b81811015610de257610dd7600082610dab565b600181019050610dc4565b5050565b601f821115610e2757610df881610cc7565b610e0184610cdc565b81016020851015610e10578190505b610e24610e1c85610cdc565b830182610dc3565b50505b505050565b600082821c905092915050565b6000610e4a60001984600802610e2c565b1980831691505092915050565b6000610e638383610e39565b9150826002028217905092915050565b610e7c8261062d565b67ffffffffffffffff811115610e9557610e9461090a565b5b610e9f8254610c96565b610eaa828285610de6565b600060209050601f831160018114610edd5760008415610ecb578287015190505b610ed58582610e57565b865550610f3d565b601f198416610eeb86610cc7565b60005b82811015610f1357848901518255600182019150602085019450602081019050610eee565b86831015610f305784890151610f2c601f891682610e39565b8355505b6001600288020188555050505b50505050505056fea2646970667358221220f6b3dcc35ac6b7418671dedc92e9dd62a6e853d95b1c3559cbd969d8e5cac92164736f6c63430008120033"

// Connect to the database
const db = new Database();

var provider;
var signer;

const routerContractAddress = "0x38BEdf17Fd49cddF9760775cC9fe16A741C7a302";

export const connectWallet = async () => {
    provider = new ethers.BrowserProvider(window.ethereum);
  
    await provider.send("eth_requestAccounts", []);
  
    signer = await provider.getSigner();
  
    console.log(signer);
}

export const getUser = () => {
    return [provider, signer];
}

export const getUserAddress = async () => {
    const address = await signer.address;
    return address;
}

function getInputs(questions, inputTypes) {
    const modifiedQuestions = questions.map((question, i) => {
        const modifiedQuestion = question.replace(/\s/g, '_');
        const inputType = inputTypes[i];
        return `${modifiedQuestion}${inputType}`;
    });
  
    const modifiedInputTypes = inputTypes.map((inputType) => {
      // Change "file" to "text"
      if (inputType === "file") {
        return "text";
      }
      // Change "number" to "integer"
      else if (inputType === "number") {
        return "integer";
      }
      // Leave other input types unchanged
      else {
        return inputType;
      }
    });
  
    return [modifiedQuestions, modifiedInputTypes];
}

function concatCreationArray(fields, types) {
    if (fields.length !== types.length) {
      throw new Error('Fields and types arrays must have the same length');
    }
  
    let queryString = '';
  
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += `${fields[i]} ${types[i]}`;
      } else {
        queryString += `${fields[i]} ${types[i]},`;
      }
    }
  
    return queryString;
}

function concatWriteArray(fields) {
    let queryString = '';
    
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += fields[i];
      } else {
        queryString += fields[i] + ',';
      }
    }
    
    return queryString;
  }

const create = async (_questions, _inputTypes, _name, details,  contractAddress) => { // add the fee and reward feature
    const [questions, inputTypes] = getInputs(_questions, _inputTypes);
    // construct contract
    const formContract = new ethers.Contract(contractAddress, formABI, signer);
    // get create string
    const createString = concatCreationArray(questions, inputTypes);
    const writeString = concatWriteArray(questions);
    const name = _name.replace(/\s/g, '_');
    // call function to create table
    const tx = await formContract.createTable(name, createString, details, writeString);
    const receipt = await tx.wait();
    console.log(name, writeString);
    return[receipt, name];
}

const deploy = async () => {
  const ControllerInstance = new ethers.ContractFactory(controllerABI, controllerBytecode, signer);
  const controllerInstance = await ControllerInstance.deploy();
  const controllerAddress = await controllerInstance.getAddress();

  const ContractInstance = new ethers.ContractFactory(formABI, bytecode, signer);
  const contractInstance = await ContractInstance.deploy(routerContractAddress, controllerAddress);

  const contractAddress = await contractInstance.getAddress();

  console.log(contractAddress);
  return [contractAddress, controllerAddress];
}

export const createForm = async (_questions, _inputTypes, name, details, _fee) => {
    await connectWallet();
    let receipt;
    let formName;
    let newContractAddress;
    let controllerAddress;

    const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
    const userAddress = await getUserAddress();
    const _userAddress = userAddress.toString();
    const contractAddress = await routerContract.getContract(_userAddress);

    if (contractAddress == '0x0000000000000000000000000000000000000000') {
        [newContractAddress, controllerAddress] = await deploy();
        const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
        const fee = ethers.parseEther(_fee);
        await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, newContractAddress);
        console.log(receipt);
        return formName;
    } else {
      const formContract = new ethers.Contract(contractAddress, formABI, signer);
      const controllerAddress = await formContract.controllerContract();
      const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
      const fee = ethers.parseEther(_fee.toString());
      await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, contractAddress);
        console.log(receipt);
        return formName;
    }
}

function processInputString(inputString) {
  // Split the input string by ","
  const parts = inputString.split(',');

  // Define a regular expression to match "text", "number", or "file" at the end of a word
  const regex = /(text|number|file)$/;

  // Initialize the result array
  const result = [];

  // Process each part
  for (const part of parts) {
      // Remove "_" and convert to lowercase
      const cleanedPart = part.replace(/_/g, ' ').toLowerCase();

      // Check if the cleaned part ends with "text", "number", or "file"
      const match = cleanedPart.match(regex);

      if (match) {
          // Extract the question by removing the matched suffix
          const question = cleanedPart.replace(match[0], '').trim();

          // Create an object and push it to the result array
          result.push({ question, inputType: match[0] });
      }
  }

  return result;
}

// create function to get a form
// get table contract and id using tableName(get TableName from search params)
// construct contract
// get questions and by types by separating the question from the '(inputType)' get them and concat to arrays then return them
export const getForm = async (tableName) => {
    let _tableName;
    let formContractAddress;
    let _tableId;
    let formOwner;
    let tableId;
    let tableDescription;
    let _columns;
    let responseCount;
    const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk")
    
    const routerContract = new ethers.Contract(routerContractAddress, routerABI, alchemyProvider);
    [_tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
    const formContract = new ethers.Contract(formContractAddress, formABI, alchemyProvider);
    [tableId, _tableName, tableDescription, _columns, responseCount] = await formContract.getTable(_tableId);

    const tableName_ = _tableName.replace(/_/g, ' ');
    const formInfo = [tableName_, tableDescription]
    const questions = processInputString(_columns);
    console.log(questions, formInfo);
    return [questions, formInfo];
}

const storeFiles = async (files) => {
  try {
    const apiToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkaWQ6ZXRocjoweEU2YTk4NDRCNWZGYjg3NzhkRGZEYTc3RkJiQzhmRjI1ODk4MzFFYTUiLCJpc3MiOiJ3ZWIzLXN0b3JhZ2UiLCJpYXQiOjE2OTU2MzUwMTMyOTcsIm5hbWUiOiJEZUZvcm0ifQ.pjouYwZNbsvuI088BsweD-0v8lhwP-DqYPQsYVaXfHU"; 
    const client = new Web3Storage({ token: apiToken });
    const cid = await client.put(files);
    console.log("stored files with cid:", cid);
    console.log(cid);
    return cid;
  } catch (error) {
    console.log(error);
  }
}

// create function to get responses from users
const getResponse = async (array) => {
    const responses = [];
    // run through the array to check if the answer is a file
    for (const item of array) {
        let response;
        console.log(item)
        console.log(item.answer.constructor)
        console.log(item.answer instanceof File)
        if (typeof item.answer === 'object' && item.answer.constructor === File)
        {
            // If the answer is a file, store it on IPFS
            const cid = await storeFiles(item.answer);
            response = cid;
            console.log(cid);
        } else if (typeof item.answer === 'number') {
            response = item.answer.toString();
        } else {
            response = item.answer;
        }
        responses.push(response);
    }
    console.log(responses);
    return responses
}


export const submitForm = async (tableName, _responses) => {
  let tableId;
  let formContractAddress;
  let formOwner;
  // const gasLimit = 300000;
  // const gasPriceInWei = ethers.parseUnits('25', 'gwei');

  const responses = await getResponse(_responses);
  const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
  [tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
  const formContract = new ethers.Contract(formContractAddress, formABI, signer);
  const controllerAddress = await formContract.controllerContract();
  const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
  const fee = await controllerContract.fee();
  const tx = await formContract.writeTable(tableId, responses,
  {value: fee})
  const receipt = await tx.wait();
  console.log(receipt, responses, controllerAddress);
}

export const shortenUrl = async (longUrl) => {
  const bitlyAccessToken = "a8bedc3b5fde1d3b1f381b54c169ac09187ecd13";

  try {
    const response = await axios.post(
      'https://api-ssl.bitly.com/v4/shorten',
      {
        long_url: longUrl,
        domain: 'bit.ly', // You can specify a custom domain if you have one
      },
      {
        headers: {
          Authorization: `Bearer ${bitlyAccessToken}`,
        },
      }
    );

    return response.data.link;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}

const trimForm = async (arr) => {
  // Check if the array has at least 4 elements
  if (arr.length >= 4) {
    // Create a new array by filtering out the element at index 3 (4th element)
    return arr.filter((_, index) => index !== 3);
  }
  return arr;
}

// function to return all forms of a user
export const getUserForms = async (formOwner) => {
  const resultArray = [];

  try {
    const alchemyProvider = new ethers.JsonRpcProvider("https://polygon-mumbai.g.alchemy.com/v2/4sKDiSJ0nsbJMKVcLjQALWBsrLroi5Sk");

    const routerContract = new ethers.Contract(routerContractAddress, routerABI, alchemyProvider);

    const userContract = await routerContract.getContract(formOwner);
    const formContract = new ethers.Contract(userContract, formABI, alchemyProvider);

    const _tableCount = await formContract.getCount();
    const tableIndex = Number(_tableCount);

    for (let index = 0; index < tableIndex; index++) {
      const _table = await formContract.getTable(index);
      const table = await trimForm(_table);
      resultArray.push(table);
    }
    console.log(resultArray);
    return resultArray;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}