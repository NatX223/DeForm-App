import { ethers } from "ethers";
import { Database, helpers } from "@tableland/sdk";
import { routerABI } from "./RouterABI";
import { formABI } from "./formABI";
import { controllerABI } from "./controllerABI";
import axios from 'axios';

require("dotenv").config();

const bytecode = "60806040523480156200001157600080fd5b5060405162005047380380620050478339818101604052810190620000379190620001c9565b6040518060400160405280600481526020017f68617368000000000000000000000000000000000000000000000000000000008152506200007e816200014a60201b60201c565b5033600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555081600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505062000571565b80600290816200015b91906200048a565b5050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620001918262000164565b9050919050565b620001a38162000184565b8114620001af57600080fd5b50565b600081519050620001c38162000198565b92915050565b60008060408385031215620001e357620001e26200015f565b5b6000620001f385828601620001b2565b92505060206200020685828601620001b2565b9150509250929050565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200029257607f821691505b602082108103620002a857620002a76200024a565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302620003127fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620002d3565b6200031e8683620002d3565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006200036b620003656200035f8462000336565b62000340565b62000336565b9050919050565b6000819050919050565b62000387836200034a565b6200039f620003968262000372565b848454620002e0565b825550505050565b600090565b620003b6620003a7565b620003c38184846200037c565b505050565b5b81811015620003eb57620003df600082620003ac565b600181019050620003c9565b5050565b601f8211156200043a576200040481620002ae565b6200040f84620002c3565b810160208510156200041f578190505b620004376200042e85620002c3565b830182620003c8565b50505b505050565b600082821c905092915050565b60006200045f600019846008026200043f565b1980831691505092915050565b60006200047a83836200044c565b9150826002028217905092915050565b620004958262000210565b67ffffffffffffffff811115620004b157620004b06200021b565b5b620004bd825462000279565b620004ca828285620003ef565b600060209050601f831160018114620005025760008415620004ed578287015190505b620004f985826200046c565b86555062000569565b601f1984166200051286620002ae565b60005b828110156200053c5784890151825560018201915060208501945060208101905062000515565b868310156200055c578489015162000558601f8916826200044c565b8355505b6001600288020188555050505b505050505050565b614ac680620005816000396000f3fe6080604052600436106101125760003560e01c80634e1273f4116100a0578063a87d942c11610064578063a87d942c146103cd578063b504b0b1146103f8578063b5a01c4e14610435578063e985e9c514610460578063f242432a1461049d57610112565b80634e1273f4146102f757806381909ebb146103345780638da5cb5b146103505780639fe1c16e1461037b578063a22cb465146103a457610112565b80630e89341c116100e75780630e89341c146101f7578063150b7a0214610234578063195e251f146102715780632eb2c2d6146102b257806339987448146102db57610112565b806263bdac14610117578062fdd58e1461015457806301ffc9a7146101915780630a531dfd146101ce575b600080fd5b34801561012357600080fd5b5061013e60048036038101906101399190612abb565b6104c6565b60405161014b9190612b78565b60405180910390f35b34801561016057600080fd5b5061017b60048036038101906101769190612bf8565b61056e565b6040516101889190612c47565b60405180910390f35b34801561019d57600080fd5b506101b860048036038101906101b39190612cba565b610636565b6040516101c59190612d02565b60405180910390f35b3480156101da57600080fd5b506101f560048036038101906101f09190612e52565b610718565b005b34801561020357600080fd5b5061021e60048036038101906102199190612abb565b610aa3565b60405161022b9190612b78565b60405180910390f35b34801561024057600080fd5b5061025b60048036038101906102569190612fca565b610b37565b604051610268919061305c565b60405180910390f35b34801561027d57600080fd5b5061029860048036038101906102939190612abb565b610b4b565b6040516102a9959493929190613077565b60405180910390f35b3480156102be57600080fd5b506102d960048036038101906102d491906131a7565b610d78565b005b6102f560048036038101906102f09190613357565b610e19565b005b34801561030357600080fd5b5061031e60048036038101906103199190613476565b611384565b60405161032b91906135ac565b60405180910390f35b61034e600480360381019061034991906135ce565b61149d565b005b34801561035c57600080fd5b50610365611531565b604051610372919061361d565b60405180910390f35b34801561038757600080fd5b506103a2600480360381019061039d9190613638565b611557565b005b3480156103b057600080fd5b506103cb60048036038101906103c691906136a4565b611663565b005b3480156103d957600080fd5b506103e2611679565b6040516103ef9190612c47565b60405180910390f35b34801561040457600080fd5b5061041f600480360381019061041a9190612abb565b61168a565b60405161042c9190612b78565b60405180910390f35b34801561044157600080fd5b5061044a61172f565b604051610457919061361d565b60405180910390f35b34801561046c57600080fd5b50610487600480360381019061048291906136e4565b611755565b6040516104949190612d02565b60405180910390f35b3480156104a957600080fd5b506104c460048036038101906104bf9190613724565b6117e9565b005b60606007600083815260200190815260200160002060030180546104e9906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610515906137ea565b80156105625780601f1061053757610100808354040283529160200191610562565b820191906000526020600020905b81548152906001019060200180831161054557829003601f168201915b50505050509050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036105de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105d59061388d565b60405180910390fd5b60008083815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b60007fd9b67a26000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061070157507f0e89341c000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b8061071157506107108261188a565b5b9050919050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461077257600080fd5b600061077c6118f4565b73ffffffffffffffffffffffffffffffffffffffff1663a15ab08d306107c1876040516020016107ac919061390f565b60405160208183030381529060405289611af3565b6040518363ffffffff1660e01b81526004016107de929190613935565b6020604051808303816000875af11580156107fd573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610821919061397a565b905060008561082f46611b29565b61083884611b29565b60405160200161084a939291906139cd565b6040516020818303038152906040529050836007600061086a6003611bf7565b815260200190815260200160002060040190816108879190613bc8565b5085600760006108976003611bf7565b815260200190815260200160002060020190816108b49190613bc8565b506108bf6003611bf7565b600760006108cd6003611bf7565b81526020019081526020016000206000018190555081600760006108f16003611bf7565b81526020019081526020016000206001018190555080600760006109156003611bf7565b815260200190815260200160002060030190816109329190613bc8565b5061093b6118f4565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab973084600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161099993929190613c9a565b600060405180830381600087803b1580156109b357600080fd5b505af11580156109c7573d6000803e3d6000fd5b5050505082600960006109da6003611bf7565b815260200190815260200160002090816109f49190613bc8565b50600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16633db88432338830610a406003611bf7565b6040518563ffffffff1660e01b8152600401610a5f9493929190613cd1565b600060405180830381600087803b158015610a7957600080fd5b505af1158015610a8d573d6000803e3d6000fd5b50505050610a9b6003611c05565b505050505050565b606060028054610ab2906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610ade906137ea565b8015610b2b5780601f10610b0057610100808354040283529160200191610b2b565b820191906000526020600020905b815481529060010190602001808311610b0e57829003601f168201915b50505050509050919050565b600063150b7a0260e01b9050949350505050565b60006060806060600060076000878152602001908152602001600020600001546007600088815260200190815260200160002060020160076000898152602001908152602001600020600401600960008a8152602001908152602001600020600760008b815260200190815260200160002060050154838054610bcd906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610bf9906137ea565b8015610c465780601f10610c1b57610100808354040283529160200191610c46565b820191906000526020600020905b815481529060010190602001808311610c2957829003601f168201915b50505050509350828054610c59906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610c85906137ea565b8015610cd25780601f10610ca757610100808354040283529160200191610cd2565b820191906000526020600020905b815481529060010190602001808311610cb557829003601f168201915b50505050509250818054610ce5906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610d11906137ea565b8015610d5e5780601f10610d3357610100808354040283529160200191610d5e565b820191906000526020600020905b815481529060010190602001808311610d4157829003601f168201915b505050505091509450945094509450945091939590929450565b610d80611c1b565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480610dc65750610dc585610dc0611c1b565b611755565b5b610e05576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dfc90613d8f565b60405180910390fd5b610e128585858585611c23565b5050505050565b6000610e2482611f44565b90506000600960008581526020019081526020016000208054610e46906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610e72906137ea565b8015610ebf5780601f10610e9457610100808354040283529160200191610ebf565b820191906000526020600020905b815481529060010190602001808311610ea257829003601f168201915b50505050509050600860008581526020019081526020016000206001015447118015610f01575060006008600086815260200190815260200160002060000154115b1561119c57610f0e6118f4565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da34306007600089815260200190815260200160002060000154611060600760008b81526020019081526020016000206002018054610f66906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054610f92906137ea565b8015610fdf5780601f10610fb457610100808354040283529160200191610fdf565b820191906000526020600020905b815481529060010190602001808311610fc257829003601f168201915b5050505050600760008c8152602001908152602001600020600001548860405160200161100c9190613dd5565b60405160208183030381529060405261103a600760008f815260200190815260200160002060050154611b29565b8b60405160200161104c929190613e21565b604051602081830303815290604052612016565b6040518563ffffffff1660e01b815260040161107e93929190613e54565b6000604051808303818588803b15801561109757600080fd5b505af11580156110ab573d6000803e3d6000fd5b50505050506000803373ffffffffffffffffffffffffffffffffffffffff16346040516110d790613ec3565b60006040518083038185875af1925050503d8060008114611114576040519150601f19603f3d011682016040523d82523d6000602084013e611119565b606091505b50915091508161115e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161115590613f24565b60405180910390fd5b60016007600061116e6003611bf7565b8152602001908152602001600020600501600082825461118e9190613f73565b92505081905550505061137e565b6111a46118f4565b73ffffffffffffffffffffffffffffffffffffffff1663377af0da343060076000898152602001908152602001600020600001546112f6600760008b815260200190815260200160002060020180546111fc906137ea565b80601f0160208091040260200160405190810160405280929190818152602001828054611228906137ea565b80156112755780601f1061124a57610100808354040283529160200191611275565b820191906000526020600020905b81548152906001019060200180831161125857829003601f168201915b5050505050600760008c815260200190815260200160002060000154886040516020016112a29190613dd5565b6040516020818303038152906040526112d0600760008f815260200190815260200160002060050154611b29565b8b6040516020016112e2929190613e21565b604051602081830303815290604052612016565b6040518563ffffffff1660e01b815260040161131493929190613e54565b6000604051808303818588803b15801561132d57600080fd5b505af1158015611341573d6000803e3d6000fd5b50505050506001600760006113566003611bf7565b815260200190815260200160002060050160008282546113769190613f73565b925050819055505b50505050565b606081518351146113ca576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016113c190614019565b60405180910390fd5b6000835167ffffffffffffffff8111156113e7576113e6612d27565b5b6040519080825280602002602001820160405280156114155781602001602082028036833780820191505090505b50905060005b84518110156114925761146285828151811061143a57611439614039565b5b602002602001015185838151811061145557611454614039565b5b602002602001015161056e565b82828151811061147557611474614039565b5b6020026020010181815250508061148b90614068565b905061141b565b508091505092915050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146114f757600080fd5b3460086000848152602001908152602001600020600001819055508060086000848152602001908152602001600020600101819055505050565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146115b157600080fd5b6115b96118f4565b73ffffffffffffffffffffffffffffffffffffffff16638bb0ab97306007600086815260200190815260200160002060010154600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166040518463ffffffff1660e01b815260040161162d93929190613c9a565b600060405180830381600087803b15801561164757600080fd5b505af115801561165b573d6000803e3d6000fd5b505050505050565b61167561166e611c1b565b8383612055565b5050565b60006116856003611bf7565b905090565b60606009600083815260200190815260200160002080546116aa906137ea565b80601f01602080910402602001604051908101604052809291908181526020018280546116d6906137ea565b80156117235780601f106116f857610100808354040283529160200191611723565b820191906000526020600020905b81548152906001019060200180831161170657829003601f168201915b50505050509050919050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b6117f1611c1b565b73ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161480611837575061183685611831611c1b565b611755565b5b611876576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161186d90613d8f565b60405180910390fd5b61188385858585856121c1565b5050505050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b60006001460361191a5773012969f7e3439a9b04025b5a049eb9bad82a8c129050611af0565b600a460361193e5773fad44bf5b843de943a09d4f3e84949a11d3aa3e69050611af0565b61a4b1460361196357739abd75e8640871a5a20d3b4ee6330a04c962affd9050611af0565b61a4ba460361198857731a22854c5b1642760a827f20137a67930ae108d29050611af0565b608946036119ac57735c4e6a9e5c1e1bf445a062006faf19ea6c49afea9050611af0565b61013a46036119d1577359ef8bf2d6c102b4c42aef9189e1a9f0abfd652d9050611af0565b62aa36a746036119f75773c50c62498448acc8dbde43da77f8d5d2e2c7597d9050611af0565b6101a44603611a1c5773c72e8a7be04f2469f8c2db3f1bdf69a7d516abba9050611af0565b62066eed4603611a425773033f69e8d119205089ab15d340f5b797732f646b9050611af0565b620138814603611a6857734b48841d4b32c4650e4abc117a03fe8b51f38f689050611af0565b6204cb2f4603611a8e5773030bcf3d50cad04c2e57391b12740982a93086219050611af0565b617a694603611ab35773e7f1725e7734ce288f8367e1bb143e90bb3f05129050611af0565b466040517f264e42cf000000000000000000000000000000000000000000000000000000008152600401611ae79190612c47565b60405180910390fd5b90565b606081611aff46611b29565b84604051602001611b12939291906141e0565b604051602081830303815290604052905092915050565b606060006001611b388461245c565b01905060008167ffffffffffffffff811115611b5757611b56612d27565b5b6040519080825280601f01601f191660200182016040528015611b895781602001600182028036833780820191505090505b509050600082602001820190505b600115611bec578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a8581611be057611bdf61423d565b5b04945060008503611b97575b819350505050919050565b600081600001549050919050565b6001816000016000828254019250508190555050565b600033905090565b8151835114611c67576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c5e906142de565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603611cd6576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ccd90614370565b60405180910390fd5b6000611ce0611c1b565b9050611cf08187878787876125af565b60005b8451811015611ea1576000858281518110611d1157611d10614039565b5b602002602001015190506000858381518110611d3057611d2f614039565b5b60200260200101519050600080600084815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015611dd1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611dc890614402565b60405180910390fd5b81810360008085815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508160008085815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611e869190613f73565b9250508190555050505080611e9a90614068565b9050611cf3565b508473ffffffffffffffffffffffffffffffffffffffff168673ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb8787604051611f18929190614422565b60405180910390a4611f2e8187878787876125b7565b611f3c8187878787876125bf565b505050505050565b60608060005b835181101561200c5760018451611f619190614459565b8103611fb25781611f8b858381518110611f7e57611f7d614039565b5b6020026020010151612796565b604051602001611f9c92919061448d565b6040516020818303038152906040529150611ff9565b81611fd6858381518110611fc957611fc8614039565b5b6020026020010151612796565b604051602001611fe79291906144b1565b60405160208183030381529060405291505b808061200490614068565b915050611f4a565b5080915050919050565b6060600061202486866127bf565b905080848460405160200161203b9392919061457c565b604051602081830303815290604052915050949350505050565b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036120c3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016120ba9061464b565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31836040516121b49190612d02565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603612230576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161222790614370565b60405180910390fd5b600061223a611c1b565b90506000612247856127fd565b90506000612254856127fd565b90506122648389898585896125af565b600080600088815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050858110156122fb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016122f290614402565b60405180910390fd5b85810360008089815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508560008089815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546123b09190613f73565b925050819055508773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f628a8a60405161242d92919061466b565b60405180910390a4612443848a8a86868a6125b7565b612451848a8a8a8a8a612877565b505050505050505050565b600080600090507a184f03e93ff9f4daa797ed6e38ed64bf6a1f01000000000000000083106124ba577a184f03e93ff9f4daa797ed6e38ed64bf6a1f01000000000000000083816124b0576124af61423d565b5b0492506040810190505b6d04ee2d6d415b85acef810000000083106124f7576d04ee2d6d415b85acef810000000083816124ed576124ec61423d565b5b0492506020810190505b662386f26fc10000831061252657662386f26fc10000838161251c5761251b61423d565b5b0492506010810190505b6305f5e100831061254f576305f5e10083816125455761254461423d565b5b0492506008810190505b612710831061257457612710838161256a5761256961423d565b5b0492506004810190505b60648310612597576064838161258d5761258c61423d565b5b0492506002810190505b600a83106125a6576001810190505b80915050919050565b505050505050565b505050505050565b6125de8473ffffffffffffffffffffffffffffffffffffffff16612a4e565b1561278e578373ffffffffffffffffffffffffffffffffffffffff1663bc197c8187878686866040518663ffffffff1660e01b81526004016126249594939291906146e9565b6020604051808303816000875af192505050801561266057506040513d601f19601f8201168201806040525081019061265d9190614766565b60015b6127055761266c6147a0565b806308c379a0036126c857506126806147c2565b8061268b57506126ca565b806040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016126bf9190612b78565b60405180910390fd5b505b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016126fc906148c4565b60405180910390fd5b63bc197c8160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161461278c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161278390614956565b60405180910390fd5b505b505050505050565b6060816040516020016127a991906149c2565b6040516020818303038152906040529050919050565b6060826127cb46611b29565b6127d484611b29565b6040516020016127e6939291906149ef565b604051602081830303815290604052905092915050565b60606000600167ffffffffffffffff81111561281c5761281b612d27565b5b60405190808252806020026020018201604052801561284a5781602001602082028036833780820191505090505b509050828160008151811061286257612861614039565b5b60200260200101818152505080915050919050565b6128968473ffffffffffffffffffffffffffffffffffffffff16612a4e565b15612a46578373ffffffffffffffffffffffffffffffffffffffff1663f23a6e6187878686866040518663ffffffff1660e01b81526004016128dc959493929190614a36565b6020604051808303816000875af192505050801561291857506040513d601f19601f820116820180604052508101906129159190614766565b60015b6129bd576129246147a0565b806308c379a00361298057506129386147c2565b806129435750612982565b806040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016129779190612b78565b60405180910390fd5b505b6040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016129b4906148c4565b60405180910390fd5b63f23a6e6160e01b7bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916817bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614612a44576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401612a3b90614956565b60405180910390fd5b505b505050505050565b6000808273ffffffffffffffffffffffffffffffffffffffff163b119050919050565b6000604051905090565b600080fd5b600080fd5b6000819050919050565b612a9881612a85565b8114612aa357600080fd5b50565b600081359050612ab581612a8f565b92915050565b600060208284031215612ad157612ad0612a7b565b5b6000612adf84828501612aa6565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b83811015612b22578082015181840152602081019050612b07565b60008484015250505050565b6000601f19601f8301169050919050565b6000612b4a82612ae8565b612b548185612af3565b9350612b64818560208601612b04565b612b6d81612b2e565b840191505092915050565b60006020820190508181036000830152612b928184612b3f565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000612bc582612b9a565b9050919050565b612bd581612bba565b8114612be057600080fd5b50565b600081359050612bf281612bcc565b92915050565b60008060408385031215612c0f57612c0e612a7b565b5b6000612c1d85828601612be3565b9250506020612c2e85828601612aa6565b9150509250929050565b612c4181612a85565b82525050565b6000602082019050612c5c6000830184612c38565b92915050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b612c9781612c62565b8114612ca257600080fd5b50565b600081359050612cb481612c8e565b92915050565b600060208284031215612cd057612ccf612a7b565b5b6000612cde84828501612ca5565b91505092915050565b60008115159050919050565b612cfc81612ce7565b82525050565b6000602082019050612d176000830184612cf3565b92915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b612d5f82612b2e565b810181811067ffffffffffffffff82111715612d7e57612d7d612d27565b5b80604052505050565b6000612d91612a71565b9050612d9d8282612d56565b919050565b600067ffffffffffffffff821115612dbd57612dbc612d27565b5b612dc682612b2e565b9050602081019050919050565b82818337600083830152505050565b6000612df5612df084612da2565b612d87565b905082815260208101848484011115612e1157612e10612d22565b5b612e1c848285612dd3565b509392505050565b600082601f830112612e3957612e38612d1d565b5b8135612e49848260208601612de2565b91505092915050565b60008060008060808587031215612e6c57612e6b612a7b565b5b600085013567ffffffffffffffff811115612e8a57612e89612a80565b5b612e9687828801612e24565b945050602085013567ffffffffffffffff811115612eb757612eb6612a80565b5b612ec387828801612e24565b935050604085013567ffffffffffffffff811115612ee457612ee3612a80565b5b612ef087828801612e24565b925050606085013567ffffffffffffffff811115612f1157612f10612a80565b5b612f1d87828801612e24565b91505092959194509250565b600067ffffffffffffffff821115612f4457612f43612d27565b5b612f4d82612b2e565b9050602081019050919050565b6000612f6d612f6884612f29565b612d87565b905082815260208101848484011115612f8957612f88612d22565b5b612f94848285612dd3565b509392505050565b600082601f830112612fb157612fb0612d1d565b5b8135612fc1848260208601612f5a565b91505092915050565b60008060008060808587031215612fe457612fe3612a7b565b5b6000612ff287828801612be3565b945050602061300387828801612be3565b935050604061301487828801612aa6565b925050606085013567ffffffffffffffff81111561303557613034612a80565b5b61304187828801612f9c565b91505092959194509250565b61305681612c62565b82525050565b6000602082019050613071600083018461304d565b92915050565b600060a08201905061308c6000830188612c38565b818103602083015261309e8187612b3f565b905081810360408301526130b28186612b3f565b905081810360608301526130c68185612b3f565b90506130d56080830184612c38565b9695505050505050565b600067ffffffffffffffff8211156130fa576130f9612d27565b5b602082029050602081019050919050565b600080fd5b600061312361311e846130df565b612d87565b905080838252602082019050602084028301858111156131465761314561310b565b5b835b8181101561316f578061315b8882612aa6565b845260208401935050602081019050613148565b5050509392505050565b600082601f83011261318e5761318d612d1d565b5b813561319e848260208601613110565b91505092915050565b600080600080600060a086880312156131c3576131c2612a7b565b5b60006131d188828901612be3565b95505060206131e288828901612be3565b945050604086013567ffffffffffffffff81111561320357613202612a80565b5b61320f88828901613179565b935050606086013567ffffffffffffffff8111156132305761322f612a80565b5b61323c88828901613179565b925050608086013567ffffffffffffffff81111561325d5761325c612a80565b5b61326988828901612f9c565b9150509295509295909350565b600067ffffffffffffffff82111561329157613290612d27565b5b602082029050602081019050919050565b60006132b56132b084613276565b612d87565b905080838252602082019050602084028301858111156132d8576132d761310b565b5b835b8181101561331f57803567ffffffffffffffff8111156132fd576132fc612d1d565b5b80860161330a8982612e24565b855260208501945050506020810190506132da565b5050509392505050565b600082601f83011261333e5761333d612d1d565b5b813561334e8482602086016132a2565b91505092915050565b6000806040838503121561336e5761336d612a7b565b5b600061337c85828601612aa6565b925050602083013567ffffffffffffffff81111561339d5761339c612a80565b5b6133a985828601613329565b9150509250929050565b600067ffffffffffffffff8211156133ce576133cd612d27565b5b602082029050602081019050919050565b60006133f26133ed846133b3565b612d87565b905080838252602082019050602084028301858111156134155761341461310b565b5b835b8181101561343e578061342a8882612be3565b845260208401935050602081019050613417565b5050509392505050565b600082601f83011261345d5761345c612d1d565b5b813561346d8482602086016133df565b91505092915050565b6000806040838503121561348d5761348c612a7b565b5b600083013567ffffffffffffffff8111156134ab576134aa612a80565b5b6134b785828601613448565b925050602083013567ffffffffffffffff8111156134d8576134d7612a80565b5b6134e485828601613179565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61352381612a85565b82525050565b6000613535838361351a565b60208301905092915050565b6000602082019050919050565b6000613559826134ee565b61356381856134f9565b935061356e8361350a565b8060005b8381101561359f5781516135868882613529565b975061359183613541565b925050600181019050613572565b5085935050505092915050565b600060208201905081810360008301526135c6818461354e565b905092915050565b600080604083850312156135e5576135e4612a7b565b5b60006135f385828601612aa6565b925050602061360485828601612aa6565b9150509250929050565b61361781612bba565b82525050565b6000602082019050613632600083018461360e565b92915050565b6000806040838503121561364f5761364e612a7b565b5b600061365d85828601612aa6565b925050602061366e85828601612be3565b9150509250929050565b61368181612ce7565b811461368c57600080fd5b50565b60008135905061369e81613678565b92915050565b600080604083850312156136bb576136ba612a7b565b5b60006136c985828601612be3565b92505060206136da8582860161368f565b9150509250929050565b600080604083850312156136fb576136fa612a7b565b5b600061370985828601612be3565b925050602061371a85828601612be3565b9150509250929050565b600080600080600060a086880312156137405761373f612a7b565b5b600061374e88828901612be3565b955050602061375f88828901612be3565b945050604061377088828901612aa6565b935050606061378188828901612aa6565b925050608086013567ffffffffffffffff8111156137a2576137a1612a80565b5b6137ae88828901612f9c565b9150509295509295909350565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061380257607f821691505b602082108103613815576138146137bb565b5b50919050565b7f455243313135353a2061646472657373207a65726f206973206e6f742061207660008201527f616c6964206f776e657200000000000000000000000000000000000000000000602082015250565b6000613877602a83612af3565b91506138828261381b565b604082019050919050565b600060208201905081810360008301526138a68161386a565b9050919050565b7f696420696e7465676572207072696d617279206b65792c000000000000000000815250565b600081905092915050565b60006138e982612ae8565b6138f381856138d3565b9350613903818560208601612b04565b80840191505092915050565b600061391a826138ad565b60178201915061392a82846138de565b915081905092915050565b600060408201905061394a600083018561360e565b818103602083015261395c8184612b3f565b90509392505050565b60008151905061397481612a8f565b92915050565b6000602082840312156139905761398f612a7b565b5b600061399e84828501613965565b91505092915050565b7f5f00000000000000000000000000000000000000000000000000000000000000815250565b60006139d982866138de565b91506139e4826139a7565b6001820191506139f482856138de565b91506139ff826139a7565b600182019150613a0f82846138de565b9150819050949350505050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b600060088302613a7e7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613a41565b613a888683613a41565b95508019841693508086168417925050509392505050565b6000819050919050565b6000613ac5613ac0613abb84612a85565b613aa0565b612a85565b9050919050565b6000819050919050565b613adf83613aaa565b613af3613aeb82613acc565b848454613a4e565b825550505050565b600090565b613b08613afb565b613b13818484613ad6565b505050565b5b81811015613b3757613b2c600082613b00565b600181019050613b19565b5050565b601f821115613b7c57613b4d81613a1c565b613b5684613a31565b81016020851015613b65578190505b613b79613b7185613a31565b830182613b18565b50505b505050565b600082821c905092915050565b6000613b9f60001984600802613b81565b1980831691505092915050565b6000613bb88383613b8e565b9150826002028217905092915050565b613bd182612ae8565b67ffffffffffffffff811115613bea57613be9612d27565b5b613bf482546137ea565b613bff828285613b3b565b600060209050601f831160018114613c325760008415613c20578287015190505b613c2a8582613bac565b865550613c92565b601f198416613c4086613a1c565b60005b82811015613c6857848901518255600182019150602085019450602081019050613c43565b86831015613c855784890151613c81601f891682613b8e565b8355505b6001600288020188555050505b505050505050565b6000606082019050613caf600083018661360e565b613cbc6020830185612c38565b613cc9604083018461360e565b949350505050565b6000608082019050613ce6600083018761360e565b8181036020830152613cf88186612b3f565b9050613d07604083018561360e565b613d146060830184612c38565b95945050505050565b7f455243313135353a2063616c6c6572206973206e6f7420746f6b656e206f776e60008201527f6572206f7220617070726f766564000000000000000000000000000000000000602082015250565b6000613d79602e83612af3565b9150613d8482613d1d565b604082019050919050565b60006020820190508181036000830152613da881613d6c565b9050919050565b7f69642c0000000000000000000000000000000000000000000000000000000000815250565b6000613de082613daf565b600382019150613df082846138de565b915081905092915050565b7f2c00000000000000000000000000000000000000000000000000000000000000815250565b6000613e2d82856138de565b9150613e3882613dfb565b600182019150613e4882846138de565b91508190509392505050565b6000606082019050613e69600083018661360e565b613e766020830185612c38565b8181036040830152613e888184612b3f565b9050949350505050565b600081905092915050565b50565b6000613ead600083613e92565b9150613eb882613e9d565b600082019050919050565b6000613ece82613ea0565b9150819050919050565b7f4661696c656420746f2073656e64204574686572000000000000000000000000600082015250565b6000613f0e601483612af3565b9150613f1982613ed8565b602082019050919050565b60006020820190508181036000830152613f3d81613f01565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000613f7e82612a85565b9150613f8983612a85565b9250828201905080821115613fa157613fa0613f44565b5b92915050565b7f455243313135353a206163636f756e747320616e6420696473206c656e67746860008201527f206d69736d617463680000000000000000000000000000000000000000000000602082015250565b6000614003602983612af3565b915061400e82613fa7565b604082019050919050565b6000602082019050818103600083015261403281613ff6565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600061407382612a85565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036140a5576140a4613f44565b5b600182019050919050565b7f435245415445205441424c452000000000000000000000000000000000000000600082015250565b60006140e6600d836138d3565b91506140f1826140b0565b600d82019050919050565b7f5f00000000000000000000000000000000000000000000000000000000000000600082015250565b60006141326001836138d3565b915061413d826140fc565b600182019050919050565b7f2800000000000000000000000000000000000000000000000000000000000000600082015250565b600061417e6001836138d3565b915061418982614148565b600182019050919050565b7f2900000000000000000000000000000000000000000000000000000000000000600082015250565b60006141ca6001836138d3565b91506141d582614194565b600182019050919050565b60006141eb826140d9565b91506141f782866138de565b915061420282614125565b915061420e82856138de565b915061421982614171565b915061422582846138de565b9150614230826141bd565b9150819050949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f455243313135353a2069647320616e6420616d6f756e7473206c656e6774682060008201527f6d69736d61746368000000000000000000000000000000000000000000000000602082015250565b60006142c8602883612af3565b91506142d38261426c565b604082019050919050565b600060208201905081810360008301526142f7816142bb565b9050919050565b7f455243313135353a207472616e7366657220746f20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b600061435a602583612af3565b9150614365826142fe565b604082019050919050565b600060208201905081810360008301526143898161434d565b9050919050565b7f455243313135353a20696e73756666696369656e742062616c616e636520666f60008201527f72207472616e7366657200000000000000000000000000000000000000000000602082015250565b60006143ec602a83612af3565b91506143f782614390565b604082019050919050565b6000602082019050818103600083015261441b816143df565b9050919050565b6000604082019050818103600083015261443c818561354e565b90508181036020830152614450818461354e565b90509392505050565b600061446482612a85565b915061446f83612a85565b925082820390508181111561448757614486613f44565b5b92915050565b600061449982856138de565b91506144a582846138de565b91508190509392505050565b60006144bd82856138de565b91506144c982846138de565b91506144d482613dfb565b6001820191508190509392505050565b7f494e5345525420494e544f200000000000000000000000000000000000000000600082015250565b600061451a600c836138d3565b9150614525826144e4565b600c82019050919050565b7f2956414c55455328000000000000000000000000000000000000000000000000600082015250565b60006145666008836138d3565b915061457182614530565b600882019050919050565b60006145878261450d565b915061459382866138de565b915061459e82614171565b91506145aa82856138de565b91506145b582614559565b91506145c182846138de565b91506145cc826141bd565b9150819050949350505050565b7f455243313135353a2073657474696e6720617070726f76616c2073746174757360008201527f20666f722073656c660000000000000000000000000000000000000000000000602082015250565b6000614635602983612af3565b9150614640826145d9565b604082019050919050565b6000602082019050818103600083015261466481614628565b9050919050565b60006040820190506146806000830185612c38565b61468d6020830184612c38565b9392505050565b600081519050919050565b600082825260208201905092915050565b60006146bb82614694565b6146c5818561469f565b93506146d5818560208601612b04565b6146de81612b2e565b840191505092915050565b600060a0820190506146fe600083018861360e565b61470b602083018761360e565b818103604083015261471d818661354e565b90508181036060830152614731818561354e565b9050818103608083015261474581846146b0565b90509695505050505050565b60008151905061476081612c8e565b92915050565b60006020828403121561477c5761477b612a7b565b5b600061478a84828501614751565b91505092915050565b60008160e01c9050919050565b600060033d11156147bf5760046000803e6147bc600051614793565b90505b90565b600060443d1061484f576147d4612a71565b60043d036004823e80513d602482011167ffffffffffffffff821117156147fc57505061484f565b808201805167ffffffffffffffff81111561481a575050505061484f565b80602083010160043d03850181111561483757505050505061484f565b61484682602001850186612d56565b82955050505050505b90565b7f455243313135353a207472616e7366657220746f206e6f6e2d4552433131353560008201527f526563656976657220696d706c656d656e746572000000000000000000000000602082015250565b60006148ae603483612af3565b91506148b982614852565b604082019050919050565b600060208201905081810360008301526148dd816148a1565b9050919050565b7f455243313135353a204552433131353552656365697665722072656a6563746560008201527f6420746f6b656e73000000000000000000000000000000000000000000000000602082015250565b6000614940602883612af3565b915061494b826148e4565b604082019050919050565b6000602082019050818103600083015261496f81614933565b9050919050565b7f2700000000000000000000000000000000000000000000000000000000000000600082015250565b60006149ac6001836138d3565b91506149b782614976565b600182019050919050565b60006149cd8261499f565b91506149d982846138de565b91506149e48261499f565b915081905092915050565b60006149fb82866138de565b9150614a0682614125565b9150614a1282856138de565b9150614a1d82614125565b9150614a2982846138de565b9150819050949350505050565b600060a082019050614a4b600083018861360e565b614a58602083018761360e565b614a656040830186612c38565b614a726060830185612c38565b8181036080830152614a8481846146b0565b9050969550505050505056fea26469706673582212206191daafcb28b68cd28be75f2bb8052a6f71d2b50ef1473e272040f52af569d364736f6c63430008120033"; // update bytecode

const controllerBytecode = "608060405234801561001057600080fd5b5033600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555061088b806100616000396000f3fe60806040526004361061004a5760003560e01c80633791dc6a1461004f57806366df322e1461007f57806369fe0e2d146100af5780638da5cb5b146100d8578063ddca3f4314610103575b600080fd5b6100696004803603810190610064919061045f565b61012e565b6040516100769190610690565b60405180910390f35b610099600480360381019061009491906106e8565b61013b565b6040516100a69190610690565b60405180910390f35b3480156100bb57600080fd5b506100d660048036038101906100d19190610728565b610330565b005b3480156100e457600080fd5b506100ed610394565b6040516100fa9190610764565b60405180910390f35b34801561010f57600080fd5b506101186103ba565b604051610125919061078e565b60405180910390f35b6101366103c0565b600080fd5b6101436103c0565b6000543414610187576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161017e90610806565b60405180910390fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610285576040518060c00160405280600115158152602001600115158152602001600115158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff81111561024757610246610826565b5b60405190808252806020026020018201604052801561027a57816020015b60608152602001906001900390816102655790505b50815250905061032a565b6040518060c00160405280600015158152602001600015158152602001600015158152602001604051806020016040528060008152508152602001604051806020016040528060008152508152602001600067ffffffffffffffff8111156102f0576102ef610826565b5b60405190808252806020026020018201604052801561032357816020015b606081526020019060019003908161030e5790505b5081525090505b92915050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461038a57600080fd5b8060008190555050565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60005481565b6040518060c001604052806000151581526020016000151581526020016000151581526020016060815260200160608152602001606081525090565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600061042c82610401565b9050919050565b61043c81610421565b811461044757600080fd5b50565b60008135905061045981610433565b92915050565b600060208284031215610475576104746103fc565b5b60006104838482850161044a565b91505092915050565b60008115159050919050565b6104a18161048c565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b838110156104e15780820151818401526020810190506104c6565b60008484015250505050565b6000601f19601f8301169050919050565b6000610509826104a7565b61051381856104b2565b93506105238185602086016104c3565b61052c816104ed565b840191505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b600061056f83836104fe565b905092915050565b6000602082019050919050565b600061058f82610537565b6105998185610542565b9350836020820285016105ab85610553565b8060005b858110156105e757848403895281516105c88582610563565b94506105d383610577565b925060208a019950506001810190506105af565b50829750879550505050505092915050565b600060c0830160008301516106116000860182610498565b5060208301516106246020860182610498565b5060408301516106376040860182610498565b506060830151848203606086015261064f82826104fe565b9150506080830151848203608086015261066982826104fe565b91505060a083015184820360a08601526106838282610584565b9150508091505092915050565b600060208201905081810360008301526106aa81846105f9565b905092915050565b6000819050919050565b6106c5816106b2565b81146106d057600080fd5b50565b6000813590506106e2816106bc565b92915050565b600080604083850312156106ff576106fe6103fc565b5b600061070d8582860161044a565b925050602061071e858286016106d3565b9150509250929050565b60006020828403121561073e5761073d6103fc565b5b600061074c848285016106d3565b91505092915050565b61075e81610421565b82525050565b60006020820190506107796000830184610755565b92915050565b610788816106b2565b82525050565b60006020820190506107a3600083018461077f565b92915050565b600082825260208201905092915050565b7f7061792066656520746f20696e73657274000000000000000000000000000000600082015250565b60006107f06011836107a9565b91506107fb826107ba565b602082019050919050565b6000602082019050818103600083015261081f816107e3565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fdfea2646970667358221220e114fb5acb79acc8e56995987e96605b064b61cea297253a85d5c6b2ead6e12c64736f6c63430008120033"

// Connect to the database
const db = new Database();

var provider;
var signer;

const routerContractAddress = "0x944992FFBCf4112Bd3B674dfbd33eE48Bd4cD7Da";

export const connectWallet = async () => {
    provider = new ethers.BrowserProvider(window.ethereum);
  
    await provider.send("eth_requestAccounts", []);
  
    signer = await provider.getSigner();
  
    console.log(signer);
}

export const getUser = () => {
    return [provider, signer];
}

export const getUserAddress = async () => {
    const address = await signer.address;
    return address;
}

function getInputs(questions, inputTypes) {
    const modifiedQuestions = questions.map((question, i) => {
        const modifiedQuestion = question.replace(/\s/g, '_');
        const inputType = inputTypes[i];
        return `${modifiedQuestion}${inputType}`;
    });
  
    const modifiedInputTypes = inputTypes.map((inputType) => {
      // Change "file" to "text"
      if (inputType === "file") {
        return "text";
      }
      // Change "number" to "integer"
      else if (inputType === "number") {
        return "integer";
      }
      // Leave other input types unchanged
      else {
        return inputType;
      }
    });
  
    return [modifiedQuestions, modifiedInputTypes];
}

function concatCreationArray(fields, types) {
    if (fields.length !== types.length) {
      throw new Error('Fields and types arrays must have the same length');
    }
  
    let queryString = '';
  
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += `${fields[i]} ${types[i]}`;
      } else {
        queryString += `${fields[i]} ${types[i]},`;
      }
    }
  
    return queryString;
}

function concatWriteArray(fields) {
    let queryString = '';
    
    for (let i = 0; i < fields.length; i++) {
      if (i === fields.length - 1) {
        queryString += fields[i];
      } else {
        queryString += fields[i] + ',';
      }
    }
    
    return queryString;
  }

const create = async (_questions, _inputTypes, _name, details,  contractAddress) => { // add the fee and reward feature
    const [questions, inputTypes] = getInputs(_questions, _inputTypes);
    // construct contract
    const formContract = new ethers.Contract(contractAddress, formABI, signer);
    // get create string
    const createString = concatCreationArray(questions, inputTypes);
    const writeString = concatWriteArray(questions);
    const name = _name.replace(/\s/g, '_');
    // call function to create table
    const tx = await formContract.createTable(name, createString, details, writeString);
    const receipt = await tx.wait();
    console.log(name, writeString);
    return[receipt, name];
}

const deploy = async () => {
  const ControllerInstance = new ethers.ContractFactory(controllerABI, controllerBytecode, signer);
  const controllerInstance = await ControllerInstance.deploy();
  const controllerAddress = await controllerInstance.getAddress();

  const ContractInstance = new ethers.ContractFactory(formABI, bytecode, signer);
  const contractInstance = await ContractInstance.deploy(routerContractAddress, controllerAddress);

  const contractAddress = await contractInstance.getAddress();

  console.log(contractAddress);
  return [contractAddress, controllerAddress];
}

export const createForm = async (_questions, _inputTypes, name, details, _fee) => {
    await connectWallet();
    let receipt;
    let formName;
    let newContractAddress;
    let controllerAddress;

    const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
    const userAddress = await getUserAddress();
    const _userAddress = userAddress.toString();
    const contractAddress = await routerContract.getContract(_userAddress);

    if (contractAddress == '0x0000000000000000000000000000000000000000') {
        [newContractAddress, controllerAddress] = await deploy();
        const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
        const fee = ethers.parseEther(_fee.toString())
        await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, newContractAddress);
        console.log(receipt);
        return formName;
    } else {
      const formContract = new ethers.Contract(contractAddress, formABI, signer);
      const controllerAddress = await formContract.controllerContract();
      const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
      const fee = ethers.parseEther(_fee.toString());
      await controllerContract.setFee(fee);
        [receipt, formName] = await create(_questions, _inputTypes, name, details, contractAddress);
        console.log(receipt);
        return formName;
    }
}

function processInputString(inputString) {
  // Split the input string by ","
  const parts = inputString.split(',');

  // Define a regular expression to match "text", "number", or "file" at the end of a word
  const regex = /(text|number|file)$/;

  // Initialize the result array
  const result = [];

  // Process each part
  for (const part of parts) {
      // Remove "_" and convert to lowercase
      const cleanedPart = part.replace(/_/g, ' ').toLowerCase();

      // Check if the cleaned part ends with "text", "number", or "file"
      const match = cleanedPart.match(regex);

      if (match) {
          // Extract the question by removing the matched suffix
          const question = cleanedPart.replace(match[0], '').trim();

          // Create an object and push it to the result array
          result.push({ question, inputType: match[0] });
      }
  }

  return result;
}

// create function to get a form
// get table contract and id using tableName(get TableName from search params)
// construct contract
// get questions and by types by separating the question from the '(inputType)' get them and concat to arrays then return them
export const getForm = async (tableName) => {
    let _tableName;
    let formContractAddress;
    let _tableId;
    let formOwner;
    let tableId;
    let tableDescription;
    let _columns;
    let responseCount;
    const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
    [_tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
    const formContract = new ethers.Contract(formContractAddress, formABI, signer);
    [tableId, _tableName, tableDescription, _columns, responseCount] = await formContract.getTable(_tableId);

    const tableName_ = _tableName.replace(/_/g, ' ');
    const formInfo = [tableName_, tableDescription]
    const questions = processInputString(_columns);
    console.log(questions, formInfo);
    return [questions, formInfo];
}

export const submitForm = async (tableName, _responses) => {
  let tableId;
  let formContractAddress;
  let formOwner;
  // const gasLimit = 300000;
  // const gasPriceInWei = ethers.parseUnits('25', 'gwei');

  const responses = getResponse(_responses);
  const routerContract = new ethers.Contract(routerContractAddress, routerABI, signer);
  [tableId, formContractAddress, formOwner] = await routerContract.getTable(tableName);
  const formContract = new ethers.Contract(formContractAddress, formABI, signer);
  const controllerAddress = await formContract.controllerContract();
  const controllerContract = new ethers.Contract(controllerAddress, controllerABI, signer);
  const fee = await controllerContract.fee();
  const tx = await formContract.writeTable(tableId, responses,
  {value: ethers.parseEther(fee.toString())})
  const receipt = await tx.wait();
  console.log(receipt);
}

const storeFiles = async (files) => {
  const client = new Web3Storage({ token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkaWQ6ZXRocjoweEU2YTk4NDRCNWZGYjg3NzhkRGZEYTc3RkJiQzhmRjI1ODk4MzFFYTUiLCJpc3MiOiJ3ZWIzLXN0b3JhZ2UiLCJpYXQiOjE2OTU2MzUwMTMyOTcsIm5hbWUiOiJEZUZvcm0ifQ.pjouYwZNbsvuI088BsweD-0v8lhwP-DqYPQsYVaXfHU" });
  const cid = await client.put(files);
  console.log("stored files with cid:", cid);
  return cid;
}

// create function to get responses from users
export const getResponse = async (array) => {
    const responses = [];
    // run through the array to check if the answer is a file
    for (const item of array) {
        let response;
        if (typeof item.answer === 'object' && item.answer instanceof File) {
            // If the answer is a file, store it on IPFS
            const cid = await storeFiles(item.answer);
            response = cid;
        } else if (typeof item.answer === 'number') {
            response = item.answer.toString();
        } else {
            response = item.answer;
        }
        responses.push(response);
    }
    return responses
}

export const shortenUrl = async (longUrl) => {
  const bitlyAccessToken = "a8bedc3b5fde1d3b1f381b54c169ac09187ecd13";

  try {
    const response = await axios.post(
      'https://api-ssl.bitly.com/v4/shorten',
      {
        long_url: longUrl,
        domain: 'bit.ly', // You can specify a custom domain if you have one
      },
      {
        headers: {
          Authorization: `Bearer ${bitlyAccessToken}`,
        },
      }
    );

    return response.data.link;
  } catch (error) {
    console.error('Error shortening URL:', error);
    throw error;
  }
}
